<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SecureShare - Receiver Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* Reset and Body Styles */
* { margin:0; padding:0; box-sizing:border-box; font-family:'Inter', sans-serif; }
body { display:flex; min-height:100vh; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: #f8fafc; overflow-x: hidden; }

/* Sidebar Styles */
.sidebar { width: 280px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); color: white; display: flex; flex-direction: column; padding: 30px 20px; border-right: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2); z-index: 100; flex-shrink: 0; }
.logo-container { display: flex; align-items: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
.logo-icon { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
.logo-icon i { color: white; font-size: 20px; }
.logo-text { font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.sidebar a { text-decoration: none; color: #cbd5e1; margin-bottom: 15px; font-weight: 500; padding: 12px 15px; border-radius: 10px; display: flex; align-items: center; transition: all 0.3s ease; }
.sidebar a i { margin-right: 12px; width: 20px; text-align: center; font-size: 1.1rem; }
.sidebar a:hover, .sidebar a.active { background: rgba(59, 130, 246, 0.2); color: #3b82f6; transform: translateX(5px); }
.sidebar a.logout { margin-top: auto; color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
.sidebar a.logout:hover { background: rgba(239, 68, 68, 0.1); transform: translateX(5px); }

/* Main content */
.main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }

/* Header */
header { height: 80px; display: flex; justify-content: space-between; align-items: center; padding: 0 40px; background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1); flex-shrink: 0; }
header h1 { font-size: 1.8rem; font-weight: 600; color: #e0e0e0; }
.user-info { display: flex; align-items: center; gap: 15px; }
.user-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #10b981 0%, #2ecc71 100%); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.2rem; box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }
.user-details { text-align: right; }
.user-details .sender-id { font-weight: 600; color: #94a3b8; }
.user-details .sender-id span { color: #3b82f6; }
.user-details .email { font-size: 0.9rem; color: #94a3b8; }

/* Dashboard Content Area */
.dashboard-content { padding: 30px 40px; flex-grow: 1; }

/* Dashboard stats */
.stats { display: flex; gap: 25px; margin-bottom: 30px; flex-wrap: wrap; }
.stat-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); flex: 1; min-width: 220px; border-radius: 16px; padding: 25px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.05); position: relative; overflow: hidden; animation: fadeInUp 0.6s ease-out; }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
.stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #10b981, #2ecc71); }
.stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2); }
.stat-card h3 { color: #cbd5e1; margin-bottom: 15px; font-size: 1rem; font-weight: 500; display: flex; align-items: center; }
.stat-card h3 i { margin-right: 10px; font-size: 1.2rem; color: #10b981; }
.stat-card p { font-size: 2.2rem; font-weight: 700; background: linear-gradient(135deg, #10b981 0%, #2ecc71 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.stat-card .stat-trend { font-size: 0.9rem; margin-top: 5px; display: flex; align-items: center; color: #64748b; }

/* Buttons */
.btn { padding: 12px 24px; border: none; border-radius: 10px; color: white; cursor: pointer; transition: all 0.3s ease; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; }
.btn:hover { transform: translateY(-2px); }
.btn:active { transform: translateY(0); }
.primary-btn { background: linear-gradient(135deg, #3b82f6, #8b5cf6); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
.primary-btn:hover { box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4); }
.action-btn { padding: 8px 15px; font-size: 0.9rem; background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); box-shadow: none; }
.action-btn:hover { background: rgba(59, 130, 246, 0.2); box-shadow: none; transform: translateY(-1px); }

/* Table */
.table-container { /* No padding needed here */ }
.table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.table-header h2 { font-size: 1.5rem; font-weight: 600; color: #cbd5e1; }
.table-actions { display: flex; gap: 10px; }
table { width: 100%; border-collapse: collapse; background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border-radius: 16px; overflow: hidden; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); border: 1px solid rgba(255, 255, 255, 0.05); }
thead { background: linear-gradient(90deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.3)); }
thead th { padding: 18px 15px; text-align: left; font-weight: 600; color: #cbd5e1; }
tbody td { padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); color: #e2e8f0; vertical-align: middle; }
tbody tr:last-child td { border-bottom: none; }
tbody tr:hover { background: rgba(59, 130, 246, 0.05); }
.actions-cell { display: flex; gap: 8px; }

/* Footer */
footer { padding: 20px 40px; text-align: center; margin-top: auto; color: #64748b; font-size: 0.9rem; border-top: 1px solid rgba(255, 255, 255, 0.05); flex-shrink: 0; }

/* Responsive */
@media (max-width: 768px) {
    body { flex-direction: column; }
    .sidebar { width: 100%; height: auto; padding: 20px; flex-direction: row; flex-wrap: wrap; justify-content: center; gap: 10px; }
    .logo-container { width: 100%; justify-content: center; margin-bottom: 20px; }
    .sidebar a { margin-bottom: 0; padding: 10px 15px; font-size: 0.9rem; }
    .sidebar a.logout { margin-top: 0; }
    header { padding: 0 20px; height: 70px; }
    header h1 { font-size: 1.5rem; }
    .dashboard-content { padding: 20px; }
    .stats { flex-direction: column; gap: 15px; }
    .table-header { flex-direction: column; align-items: flex-start; gap: 15px; }
    table { display: block; overflow-x: auto; }
}
@media (max-width: 480px) {
    header { flex-direction: column; height: auto; padding: 15px; gap: 10px; }
    .user-info { flex-direction: column; text-align: center; gap: 8px; }
    .user-details { text-align: center; }
}
</style>
</head>
<body>

<div class="sidebar">
    <div class="logo-container">
        <div class="logo-icon"><i class="fas fa-shield-alt"></i></div>
        <div class="logo-text">SecureShare</div>
    </div>
    <a href="receiver_dashboard.html" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
    <a href="request.html"><i class="fas fa-paper-plane"></i> Request Files</a>
    <a href="decrypt.html"><i class="fas fa-unlock"></i> Decrypt File</a>
<a href="decrypt_instructions.html" class="active">
        <i class="fas fa-question-circle"></i> How to Decrypt</a>    <a href="#" class="logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
</div>

<div class="main">
    <header>
        <h1>Receiver Dashboard</h1>
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">R</div>
            <div class="user-details">
                <div class="sender-id">Linked Sender ID: <span id="senderId"></span></div>
                <div class="email" id="email"></div>
            </div>
        </div>
    </header>

    <div class="dashboard-content">
        <div class="stats">
            <div class="stat-card">
                <h3><i class="fas fa-file-alt"></i> Total Files Received</h3>
                <p id="totalFiles">0</p>
                <div class="stat-trend"><i class="fas fa-info-circle"></i> View file list below</div>
            </div>
            
            <div class="stat-card">
                <h3><i class="fas fa-download"></i> Files Ready to Decrypt</h3>
                <p id="readyToDecrypt">0</p>
                <div class="stat-trend"><i class="fas fa-info-circle"></i> Based on received files</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                     <button class="btn primary-btn" onclick="window.location.href='request.html'"><i class="fas fa-paper-plane"></i> Request File</button>
                     <button class="btn primary-btn" onclick="window.location.href='decrypt.html'"><i class="fas fa-unlock"></i> Decrypt Now</button>
                 </div>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <h2>Received Files</h2>
                <div class="table-actions">
                    <button class="btn action-btn" onclick="refreshData()"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Original File Name</th>
                        <th>Encrypted Name</th>
                        <th>Date Received</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="fileTable">
                    <tr><td colspan="4" style="text-align:center; padding: 30px;">Loading files...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <footer>
        &copy; 2025 SecureShare. All rights reserved. | Secure file sharing for professionals
    </footer>
</div>

<script>
    const API_URL = '';
    const senderId = localStorage.getItem('senderId');
    const email = localStorage.getItem('email');
    const receiverKeysData = localStorage.getItem('receiverKeys');

    document.addEventListener('DOMContentLoaded', () => {
        if (!senderId || !email || !receiverKeysData) {
            alert('User session not found or incomplete. Redirecting to login.');
            window.location.href = 'login.html';
            return;
        }

        document.getElementById('senderId').textContent = senderId;
        document.getElementById('email').textContent = email;
        document.getElementById('userAvatar').textContent = getUserInitials(email);

        try {
            // --- THIS IS WHERE REAL DATA IS LOADED ---
            const receiverKeys = JSON.parse(receiverKeysData);
            populateDashboard(receiverKeys);
            // -----------------------------------------
        } catch (e) {
            console.error("Error parsing receiver keys from localStorage:", e);
            populateDashboard([]); // Show empty state on error
             document.getElementById('fileTable').innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 30px; color: #ef4444;">Error loading file data from session. Please re-login.</td></tr>';
        }
    });


    function getUserInitials(userEmail) {
        if (!userEmail) return 'R';
        return userEmail.split(/[\s@_.]+/).map(n => n[0]).join('').substring(0, 2).toUpperCase();
    }

    function populateDashboard(keysArray) {
        const totalFiles = keysArray.length;
        document.getElementById('totalFiles').textContent = totalFiles;
        document.getElementById('readyToDecrypt').textContent = totalFiles;

        // Placeholders - these would require different data sources
        // document.getElementById('pendingRequests').textContent = 'N/A';
        // document.getElementById('totalDownloads').textContent = 'N/A';

        const tbody = document.getElementById('fileTable');
        tbody.innerHTML = '';

        if (keysArray && keysArray.length > 0) {
            keysArray.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            keysArray.forEach(key => {
                const tr = document.createElement('tr');
                const dateReceived = new Date(key.createdAt).toLocaleDateString();
                const encryptedImage = encodeURIComponent(key.encryptedImage);
                const hashData = encodeURIComponent(key.hash);

                tr.innerHTML = `
                    <td><i class="fas fa-file-image" style="margin-right: 8px; color: #10b981;"></i> ${escapeHtml(key.image)}</td>
                    <td>${escapeHtml(key.encryptedImage)}</td>
                    <td>${dateReceived}</td>
                    <td class="actions-cell">
                        <button class="btn action-btn" onclick="goToDecrypt('${encryptedImage}', '${hashData}')">
                           <i class="fas fa-unlock"></i> Decrypt
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 30px;">No files have been shared with you yet.</td></tr>';
        }
    }

    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function goToDecrypt(encryptedFilename, hashData) {
        // Redirects to decrypt.html, passing data in URL parameters
        // IMPORTANT: decrypt.html needs to read these parameters
        const url = `decrypt.html?file=${encryptedFilename}&data=${hashData}`;
        window.location.href = url;
    }

    function refreshData() {
        // Re-read from localStorage and re-populate
        console.log('Refreshing data from localStorage...');
        const updatedKeysData = localStorage.getItem('receiverKeys');
        if (updatedKeysData) {
            try {
                const updatedKeys = JSON.parse(updatedKeysData);
                populateDashboard(updatedKeys);
                 alert('File list refreshed from current session.');
            } catch (e) {
                 alert('Error refreshing data.');
                 console.error("Error parsing receiver keys during refresh:", e);
            }
        } else {
            alert('Session data not found. Please log in again.');
            logout();
        }
    }

    function logout() {
        localStorage.clear();
        window.location.href = 'login.html';
    }
</script>

</body>
</html>