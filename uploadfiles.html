<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SecureShare - Upload & Manage Requests</title>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1481.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* Your existing CSS remains the same */
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    :root {
        --bg-gradient-start: #0f172a; --bg-gradient-end: #1e293b;
        --sidebar-bg: rgba(15, 23, 42, 0.9); --header-bg: rgba(30, 41, 59, 0.7);
        --card-bg: rgba(30, 41, 59, 0.7); --input-bg: rgba(15, 23, 42, 0.5);
        --input-focus-bg: rgba(15, 23, 42, 0.7); --input-disabled-bg: rgba(15, 23, 42, 0.3);
        --list-item-bg: rgba(15, 23, 42, 0.5); --list-item-hover-bg: rgba(30, 41, 59, 0.7);
        --text-primary: #f8fafc; --text-secondary: #e2e8f0; --text-muted: #94a3b8; --text-disabled: #64748b;
        --border-color: rgba(255, 255, 255, 0.1); --border-input: #334155; --border-focus: #3b82f6;
        --border-dashed: #334155; --accent-gradient-start: #3b82f6; --accent-gradient-end: #8b5cf6;
        --accent-text: #3b82f6; --accent-hover-bg: rgba(59, 130, 246, 0.2); --accent-focus-shadow: rgba(59, 130, 246, 0.1);
        --accent-approve-gradient-start: #10b981; --accent-approve-gradient-end: #059669;
        --accent-approve-text: #10b981; --accent-approve-shadow: rgba(16, 185, 129, 0.3);
        --accent-reject-gradient-start: #ef4444; --accent-reject-gradient-end: #dc2626;
        --accent-reject-text: #ef4444; --accent-reject-shadow: rgba(239, 68, 68, 0.3);
        --scrollbar-track-bg: rgba(15, 23, 42, 0.5); --scrollbar-thumb-bg: #334155; --scrollbar-thumb-hover-bg: #475569;
        --success-bg: rgba(16, 185, 129, 0.1); --success-border: rgba(16, 185, 129, 0.3); --success-text: #10b981;
        --error-bg: rgba(239, 68, 68, 0.1); --error-border: rgba(239, 68, 68, 0.3); --error-text: #ef4444;
        --info-bg: rgba(59, 130, 246, 0.1); --info-border: rgba(59, 130, 246, 0.3); --info-text: #3b82f6;
    }
    body { display: flex; min-height: 100vh; background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%); color: var(--text-primary); overflow-x: hidden; }
    .sidebar { width: 280px; background: var(--sidebar-bg); backdrop-filter: blur(10px); color: var(--text-secondary); display: flex; flex-direction: column; padding: 30px 20px; border-right: 1px solid var(--border-color); box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2); z-index: 100; flex-shrink: 0; }
    .logo-container { display: flex; align-items: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
    .logo-icon { background: linear-gradient(135deg, var(--accent-gradient-start) 0%, var(--accent-gradient-end) 100%); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
    .logo-icon i { color: white; font-size: 20px; }
    .logo-text { font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, var(--accent-gradient-start) 0%, var(--accent-gradient-end) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .sidebar a { text-decoration: none; color: var(--text-secondary); margin-bottom: 15px; font-weight: 500; padding: 12px 15px; border-radius: 10px; display: flex; align-items: center; transition: all 0.3s ease; }
    .sidebar a i { margin-right: 12px; width: 20px; text-align: center; font-size: 1.1rem; }
    .sidebar a:hover, .sidebar a.active { background: var(--accent-hover-bg); color: var(--accent-text); transform: translateX(5px); }
    .sidebar a.logout { margin-top: auto; color: var(--accent-reject-text); border: 1px solid var(--accent-reject-shadow); }
    .sidebar a.logout:hover { background: var(--error-bg); transform: translateX(5px); }
    .main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
    header { height: 80px; display: flex; justify-content: space-between; align-items: center; padding: 0 40px; background: var(--header-bg); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1); flex-shrink: 0; }
    header h1 { font-size: 1.8rem; font-weight: 600; color: var(--text-secondary); }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-gradient-start) 0%, var(--accent-gradient-end) 100%); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.2rem; box-shadow: 0 4px 10px var(--accent-focus-shadow); color: white; }
    .user-details { text-align: right; }
    .user-details .sender-id { font-weight: 600; color: var(--text-muted); }
    .user-details .sender-id span { color: var(--accent-text); }
    .user-details .email { font-size: 0.9rem; color: var(--text-muted); }
    .dashboard-content { padding: 30px 40px; flex-grow: 1; display: flex; flex-direction: column; gap: 30px; }
    .card { background: var(--card-bg); backdrop-filter: blur(10px); border-radius: 16px; padding: 25px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); border: 1px solid var(--border-color); animation: fadeInUp 0.6s ease-out; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .card-header { display: flex; align-items: center; margin-bottom: 20px; color: var(--text-secondary); font-size: 1.2rem; font-weight: 600; }
    .card-header i { margin-right: 10px; font-size: 1.4rem; color: var(--accent-text); }
    .file-upload-area { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
    .file-label { flex: 1; min-width: 200px; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 15px; border: 2px dashed var(--border-dashed); border-radius: 12px; color: var(--text-muted); font-weight: 500; cursor: pointer; transition: 0.3s; background: var(--input-bg); text-align: center; }
    .file-label:hover { border-color: var(--border-focus); background: var(--input-focus-bg); color: var(--text-primary); }
    .file-label i { font-size: 1.2rem; }
    input[type="file"] { display: none; }
    .btn { padding: 12px 24px; border: none; border-radius: 10px; color: white; cursor: pointer; transition: all 0.3s ease; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; }
    .btn:hover { transform: translateY(-2px); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { background: #475569; color: var(--text-disabled); cursor: not-allowed; transform: none; box-shadow: none; }
    .action-btn { background: linear-gradient(135deg, var(--accent-gradient-start), var(--accent-gradient-end)); box-shadow: 0 4px 15px var(--accent-focus-shadow); }
    .action-btn:hover { box-shadow: 0 8px 20px var(--accent-focus-shadow); }
    .approve-btn { background: linear-gradient(135deg, var(--accent-approve-gradient-start), var(--accent-approve-gradient-end)); box-shadow: 0 4px 15px var(--accent-approve-shadow); padding: 10px 16px; font-size: 0.9rem; }
    .approve-btn:hover { box-shadow: 0 8px 20px var(--accent-approve-shadow); }
    .reject-btn { background: linear-gradient(135deg, var(--accent-reject-gradient-start), var(--accent-reject-gradient-end)); box-shadow: 0 4px 15px var(--accent-reject-shadow); padding: 10px 16px; font-size: 0.9rem; }
    .reject-btn:hover { box-shadow: 0 8px 20px var(--accent-reject-shadow); }
    .list-container { margin-top: 15px; padding: 15px; border-radius: 12px; background: var(--input-bg); border: 1px solid var(--border-color); font-size: 14px; color: var(--text-secondary); min-height: 150px; max-height: 250px; overflow-y: auto; }
    .list-container::-webkit-scrollbar { width: 8px; }
    .list-container::-webkit-scrollbar-track { background: var(--scrollbar-track-bg); border-radius: 10px; }
    .list-container::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb-bg); border-radius: 10px; }
    .list-container::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover-bg); }
    .file-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
    .file-item:last-child { border-bottom: none; }
    .file-icon { margin-right: 10px; color: var(--accent-text); }
    .request { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 15px; border-radius: 12px; background: var(--list-item-bg); border: 1px solid var(--border-input); transition: background 0.3s, border-color 0.3s; }
    .request:hover { background: var(--list-item-hover-bg); border-color: var(--border-focus); }
    .request-info { display: flex; flex-direction: column; flex: 1; }
    .request-email { font-weight: 600; color: var(--accent-text); }
    .request-date { font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; }
    .request-actions { display: flex; gap: 10px; }
    .status-message { padding: 12px; border-radius: 8px; text-align: center; font-weight: 500; margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; animation: fadeInUp 0.3s ease-out; border: 1px solid transparent; }
    .status-success { background: var(--success-bg); border-color: var(--success-border); color: var(--success-text); }
    .status-error { background: var(--error-bg); border-color: var(--error-border); color: var(--error-text); }
    .status-info { background: var(--info-bg); border-color: var(--info-border); color: var(--info-text); }
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); text-align: center; padding: 20px; }
    .empty-state i { font-size: 2rem; margin-bottom: 10px; opacity: 0.5; }
    footer { padding: 20px 40px; text-align: center; margin-top: auto; color: var(--text-muted); font-size: 0.9rem; border-top: 1px solid var(--border-color); flex-shrink: 0; }
    
    /* Upload progress styles */
    .upload-progress { margin-top: 15px; }
    .progress-bar { width: 100%; height: 8px; background: var(--input-bg); border-radius: 4px; overflow: hidden; margin-bottom: 8px; }
    .progress-fill { height: 100%; background: linear-gradient(135deg, var(--accent-approve-gradient-start), var(--accent-approve-gradient-end)); transition: width 0.3s ease; }
    .progress-text { font-size: 0.8rem; color: var(--text-muted); text-align: center; }
    
    @media (max-width: 768px) { body { flex-direction: column; } .sidebar { width: 100%; height: auto; padding: 20px; flex-direction: row; flex-wrap: wrap; justify-content: center; gap: 10px; } .logo-container { width: 100%; justify-content: center; margin-bottom: 20px; } .sidebar a { margin-bottom: 0; padding: 10px 15px; font-size: 0.9rem; } .sidebar a.logout { margin-top: 0; } header { padding: 0 20px; height: 70px; } header h1 { font-size: 1.5rem; } .dashboard-content { padding: 20px; } .file-upload-area { flex-direction: column; } .request { flex-direction: column; gap: 15px; text-align: center; } .request-actions { width: 100%; justify-content: center; } }
    @media (max-width: 480px) { header { flex-direction: column; height: auto; padding: 15px; gap: 10px; } .user-info { flex-direction: column; text-align: center; gap: 8px; } .user-details { text-align: center; } }
</style>
</head>
<body>

<div class="sidebar">
    <div class="logo-container">
        <div class="logo-icon"><i class="fas fa-shield-alt"></i></div>
        <div class="logo-text">SecureShare</div>
    </div>
     <a href="sender_dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
    <a href="encrypt.html"><i class="fas fa-paper-plane"></i> Encryption</a>
    <a href="uploadfiles.html"><i class="fas fa-tasks"></i> Uploads & Accept</a>
    <a href="add_users.html"><i class="fas fa-user-plus"></i> Add Users</a>
    <a href="pending_requests.html"><i class="fas fa-clock"></i> Pending Requests</a>
    <a href="encrypt_instructions.html" class="active"><i class="fas fa-question-circle"></i> How to Encrypt/Send</a>
    <a href="#" class="logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
</div>

<div class="main">
    <header>
        <h1>Upload Files & Manage Requests</h1>
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-details">
                <div class="sender-id">ID: <span id="senderId">Loading...</span></div>
                <div class="email" id="email">Loading...</div>
            </div>
        </div>
    </header>

    <div class="dashboard-content">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-file-arrow-up"></i>
                <h2>1. Select Files to Upload</h2>
            </div>

            <div class="file-upload-area">
                <label class="file-label" for="fileUploadFiles">
                    <i class="fas fa-file-alt"></i> Choose Individual Files
                </label>
                <input type="file" id="fileUploadFiles" multiple>

                <label class="file-label" for="fileUploadFolder">
                    <i class="fas fa-folder-open"></i> Choose Entire Folder
                </label>
                <input type="file" id="fileUploadFolder" webkitdirectory directory multiple>
            </div>

            <div id="fileList" class="list-container">
                <div class="empty-state">
                    <i class="fas fa-file-import"></i>
                    <p>No files selected for upload</p>
                </div>
            </div>
            
            <div id="uploadProgress" class="upload-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">Uploading: 0%</div>
            </div>
            
            <div id="pageStatus" style="margin-top: 15px;"></div>
        </div>

        <div class="card">
            <div class="card-header">
                <i class="fas fa-inbox"></i>
                <h2>2. Manage Pending Requests</h2>
            </div>

            <button class="btn action-btn" id="refreshBtn" onclick="fetchPendingRequests()" style="margin-bottom: 20px;">
                <i class="fas fa-sync-alt"></i> Refresh Pending Requests
            </button>

            <div id="requestsList" class="list-container">
                <div class="empty-state">
                    <i class="fas fa-hourglass-half"></i>
                    <p>Click Refresh to check for pending requests</p>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        &copy; 2025 SecureShare. All rights reserved.
    </footer>
</div>

<script>
    // AWS S3 Setup
    AWS.config.region = "eu-north-1";
    AWS.config.credentials = new AWS.CognitoIdentityCredentials({ 
        IdentityPoolId: "eu-north-1:d3bfbb91-9b0b-487e-a9dc-aa750c74fc66" 
    });
    const s3 = new AWS.S3({ params: { Bucket: "uropimagesecurity" } });
    
   const API_URL = '';
    let selectedFiles = [];

    // User Info
    const senderId = localStorage.getItem('senderId');
    const email = localStorage.getItem('email');
    const userName = email ? email.split('@')[0] : 'User';

    document.addEventListener('DOMContentLoaded', () => {
        if (!senderId || !email) {
            alert('No sender info found. Redirecting to login.');
            window.location.href = 'login.html';
            return;
        }
        document.getElementById('senderId').textContent = senderId;
        document.getElementById('email').textContent = email;
        document.getElementById('userAvatar').textContent = getUserInitials(userName);
        fetchPendingRequests();

        document.getElementById("fileUploadFiles").addEventListener("change", handleFileSelection);
        document.getElementById("fileUploadFolder").addEventListener("change", handleFileSelection);
    });

    function getUserInitials(name) {
        if (!name) return 'U';
        return name.split(/[\s@_.]+/).map(n => n[0]).join('').substring(0, 2).toUpperCase();
    }

    function handleFileSelection(event) {
        selectedFiles = Array.from(event.target.files);
        showFileList();
        document.getElementById("pageStatus").innerHTML = "";
    }

    function showFileList() {
        const fileListElement = document.getElementById("fileList");
        if (selectedFiles.length) {
            fileListElement.innerHTML = selectedFiles.map(f =>
                `<div class="file-item">
                    <i class="fas fa-file file-icon"></i>
                    <span>${escapeHtml(f.webkitRelativePath || f.name)}</span>
                    <span style="margin-left: auto; font-size: 0.8rem; color: var(--text-muted);">
                        ${formatFileSize(f.size)}
                    </span>
                </div>`
            ).join("");
        } else {
            fileListElement.innerHTML = `<div class="empty-state"><i class="fas fa-file-import"></i><p>No files selected</p></div>`;
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showPageStatus(type, message) {
        const statusEl = document.getElementById("pageStatus");
        const iconClass = type === 'success' ? 'fa-check-circle' : 
                         (type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle');
        statusEl.innerHTML = `
            <div class="status-message status-${type}">
                <i class="fas ${iconClass}"></i>
                <span>${message}</span>
            </div>`;
        if (type === 'success' || type === 'info') {
            setTimeout(() => {
                if (statusEl.querySelector(`.status-${type} span`)?.textContent === message) { 
                    statusEl.innerHTML = ''; 
                }
            }, 4000);
        }
    }

    function showUploadProgress(percent, text) {
        const progressContainer = document.getElementById("uploadProgress");
        const progressFill = document.getElementById("progressFill");
        const progressText = document.getElementById("progressText");
        
        progressContainer.style.display = 'block';
        progressFill.style.width = `${percent}%`;
        progressText.textContent = text;
        
        if (percent >= 100) {
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 2000);
        }
    }

    // The fetchPendingRequests function needs to match your schema
async function fetchPendingRequests() {
    const requestsElement = document.getElementById("requestsList");
    const refreshBtn = document.getElementById('refreshBtn');
    
    requestsElement.innerHTML = `<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading pending requests...</p></div>`;
    showPageStatus('info', 'Checking for pending requests...');
    
    if(refreshBtn) { 
        refreshBtn.disabled = true; 
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...'; 
    }

    try {
        const response = await fetch(`${API_URL}/sender-requests/${senderId}/pending`);
        if (!response.ok) { 
            throw new Error(`HTTP Error ${response.status}`); 
        }
        const data = await response.json();
        if (!data.success) { 
            throw new Error(data.message || 'Backend failed'); 
        }

        let html = "";
        let requestCount = 0;

        if (data.requests && data.requests.length > 0) {
            data.requests.forEach(req => {
                requestCount++;
                html += `
                    <div class="request" id="request-${escapeHtml(req.receiverEmail)}">
                        <div class="request-info">
                            <span class="request-email">${escapeHtml(req.receiverEmail)}</span>
                            <span class="request-date">Requested on: ${new Date(req.requestedAt).toLocaleDateString()}</span>
                        </div>
                        <div class="request-actions">
                            <button class="btn approve-btn" onclick="approveAndUpload('${escapeHtml(req.receiverEmail)}')">
                                <i class="fas fa-check"></i> Approve & Upload
                            </button>
                            <button class="btn reject-btn" onclick="rejectRequest('${escapeHtml(req.receiverEmail)}')">
                                <i class="fas fa-times"></i> Deny Request
                            </button>
                        </div>
                    </div>`;
            });
        }

        if (requestCount > 0) {
            requestsElement.innerHTML = html;
            showPageStatus('success', `Found ${requestCount} pending request(s).`);
        } else {
            requestsElement.innerHTML = `<div class="empty-state"><i class="fas fa-check-circle"></i><p>No requests currently pending approval.</p></div>`;
            showPageStatus('info', 'No pending requests found.');
        }
    } catch(err) {
        console.error("Error loading pending requests:", err);
        requestsElement.innerHTML = `<div class="status-message status-error"><i class="fas fa-exclamation-triangle"></i> Failed to load pending requests. Error: ${err.message}</div>`;
        showPageStatus('error', 'Failed to load requests.');
    } finally {
        if(refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Pending Requests';
        }
    }
}
    async function approveAndUpload(recipientEmail) {
        if (!selectedFiles.length) {
            showPageStatus('error', `Please select files/folder in Step 1 to upload for ${recipientEmail}.`);
            return;
        }

        showPageStatus('info', `Processing and uploading files for ${recipientEmail}...`);
        disableRequestButtons(recipientEmail, true);

        let uploadResultLocation = null;
        let originalFileNameForDB = 'shared_files.zip';
        let s3Key = '';

        try {
            showUploadProgress(10, 'Preparing files...');

            // S3 Upload Logic
            if (selectedFiles.length === 1) {
                const singleFile = selectedFiles[0];
                originalFileNameForDB = singleFile.name;
                s3Key = `uploads/${senderId}/${recipientEmail}/${Date.now()}_${originalFileNameForDB.replace(/[^a-zA-Z0-9._-]/g, '_')}`;
                
                showUploadProgress(30, `Uploading ${originalFileNameForDB}...`);
                
                const uploadResult = await s3.upload({ 
                    Key: s3Key, 
                    Body: singleFile, 
                    ContentType: singleFile.type || 'application/octet-stream' 
                }).promise();
                
                uploadResultLocation = uploadResult.Location;
                showUploadProgress(100, 'Upload complete!');
            } else {
                showUploadProgress(20, `Zipping ${selectedFiles.length} files...`);
                
                const zip = new JSZip();
                selectedFiles.forEach(file => {
                    zip.file(file.webkitRelativePath || file.name, file);
                });
                
                const zipBlob = await zip.generateAsync({ 
                    type: "blob", 
                    compression: "DEFLATE", 
                    compressionOptions: { level: 6 } 
                });
                
                originalFileNameForDB = `shared_files_${recipientEmail.split('@')[0]}_${Date.now()}.zip`;
                s3Key = `uploads/${senderId}/${recipientEmail}/${originalFileNameForDB}`;
                
                showUploadProgress(50, `Uploading ${originalFileNameForDB}...`);
                
                const uploadResult = await s3.upload({ 
                    Key: s3Key, 
                    Body: zipBlob, 
                    ContentType: "application/zip" 
                }).promise();
                
                uploadResultLocation = uploadResult.Location;
                showUploadProgress(100, 'Upload complete!');
            }

            // Update backend with approval
            showPageStatus('info', 'Finalizing approval...');
            
            const approveResponse = await fetch(`${API_URL}/approve-request`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    senderId: senderId,
                    receiverEmail: recipientEmail,
                    fileUrl: uploadResultLocation,
                    originalFileName: originalFileNameForDB
                })
            });

            if (!approveResponse.ok) {
                const errData = await approveResponse.json();
                throw new Error(errData.message || `Failed to update status (HTTP ${approveResponse.status})`);
            }
            
            const approveData = await approveResponse.json();
            if (!approveData.success) { 
                throw new Error(approveData.message || 'Backend failed to approve request.'); 
            }

            showPageStatus('success', `Files uploaded and request approved for ${recipientEmail}!`);
            selectedFiles = [];
            showFileList();

            // Remove the processed request from UI
            const requestElement = document.getElementById(`request-${escapeHtml(recipientEmail)}`);
            if (requestElement) {
                requestElement.style.transition = 'opacity 0.3s ease-out';
                requestElement.style.opacity = '0';
                setTimeout(() => requestElement.remove(), 300);
                setTimeout(checkIfListIsEmpty, 350);
            }

        } catch (error) {
            console.error("Approve/Upload error:", error);
            showPageStatus('error', `Upload/Approval failed for ${recipientEmail}. Error: ${error.message}`);
            enableRequestButtons(recipientEmail);
            document.getElementById("uploadProgress").style.display = 'none';
        }
    }

    async function rejectRequest(receiverEmail) {
        if (!confirm(`Are you sure you want to deny the request from ${receiverEmail}?`)) return;

        showPageStatus('info', `Denying request from ${receiverEmail}...`);
        disableRequestButtons(receiverEmail, false);

        try {
            const response = await fetch(`${API_URL}/deny-request`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    senderId: senderId, 
                    receiverEmail: receiverEmail 
                })
            });

            if (!response.ok) { 
                throw new Error(`HTTP Error ${response.status}`); 
            }
            
            const data = await response.json();

            if (data.success) {
                showPageStatus('success', `Request from ${receiverEmail} denied.`);
                const requestElement = document.getElementById(`request-${escapeHtml(receiverEmail)}`);
                if (requestElement) {
                    requestElement.style.transition = 'opacity 0.3s ease-out';
                    requestElement.style.opacity = '0';
                    setTimeout(() => requestElement.remove(), 300);
                }
                setTimeout(checkIfListIsEmpty, 350);
            } else { 
                throw new Error(data.message || 'Backend failed to deny'); 
            }
        } catch (error) {
            console.error("Denial error:", error);
            showPageStatus('error', `Failed to deny request from ${receiverEmail}: ${error.message}`);
            enableRequestButtons(receiverEmail);
        }
    }

    function disableRequestButtons(receiverEmail, isApproving) {
        const requestElement = document.getElementById(`request-${escapeHtml(receiverEmail)}`);
        if (requestElement) {
            requestElement.querySelectorAll('.request-actions button').forEach(btn => {
                btn.disabled = true;
                const baseIconClass = btn.querySelector('i')?.className?.split(' ').find(cls => cls.startsWith('fa-')) || 'fa-spinner';
                const iconClass = (isApproving && btn.classList.contains('approve-btn')) || 
                                (!isApproving && btn.classList.contains('reject-btn'))
                                ? 'fa-spinner fa-spin'
                                : baseIconClass;
                const text = (isApproving && btn.classList.contains('approve-btn')) ? ' Processing...' :
                            (!isApproving && btn.classList.contains('reject-btn')) ? ' Denying...' :
                            btn.textContent.trim().replace(/^.+?\s/, '');

                btn.innerHTML = `<i class="fas ${iconClass}"></i>${text}`;
            });
        }
    }

    function enableRequestButtons(receiverEmail) {
        const requestElement = document.getElementById(`request-${escapeHtml(receiverEmail)}`);
        if (requestElement) {
            const approveBtn = requestElement.querySelector('.approve-btn');
            const rejectBtn = requestElement.querySelector('.reject-btn');
            if (approveBtn) {
                approveBtn.disabled = false;
                approveBtn.innerHTML = '<i class="fas fa-check"></i> Approve & Upload';
            }
            if (rejectBtn) {
                rejectBtn.disabled = false;
                rejectBtn.innerHTML = '<i class="fas fa-times"></i> Deny Request';
            }
        }
    }

    function checkIfListIsEmpty() {
        const requestsElement = document.getElementById("requestsList");
        if (!requestsElement.querySelector('.request')) {
            requestsElement.innerHTML = `<div class="empty-state"><i class="fas fa-check-circle"></i><p>No pending requests found.</p></div>`;
        }
    }

    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe.replace(/&/g, "&amp;")
                     .replace(/</g, "&lt;")
                     .replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;")
                     .replace(/'/g, "&#039;");
    }

    function logout() {
        localStorage.clear();
        window.location.href = 'login.html';
    }
</script>
</body>
</html>