<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pending Requests - SecureShare</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* --- FONT & RESET --- */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Inter', sans-serif;
        /* Removed transition for simplicity as theme toggle is removed */
    }

    /* --- DARK THEME VARIABLES (ONLY) --- */
    :root {
        --bg-gradient-start: #0f172a;
        --bg-gradient-end: #1e293b;
        --sidebar-bg: rgba(15, 23, 42, 0.9);
        --header-bg: rgba(30, 41, 59, 0.7);
        --card-bg: rgba(30, 41, 59, 0.7);
        --input-bg: rgba(15, 23, 42, 0.5);
        --input-focus-bg: rgba(15, 23, 42, 0.7);
        --input-disabled-bg: rgba(15, 23, 42, 0.3);
        --list-item-bg: rgba(15, 23, 42, 0.5);
        --list-item-hover-bg: rgba(30, 41, 59, 0.7);
        --list-item-selected-bg: rgba(59, 130, 246, 0.2);
        --text-primary: #f8fafc;
        --text-secondary: #e2e8f0;
        --text-muted: #94a3b8;
        --text-disabled: #64748b;
        --border-color: rgba(255, 255, 255, 0.1);
        --border-input: #334155;
        --border-focus: #3b82f6;
        --border-selected: #3b82f6;
        --border-dashed: #334155;
        --accent-gradient-start: #3b82f6;
        --accent-gradient-end: #8b5cf6;
        --accent-text: #3b82f6;
        --accent-hover-bg: rgba(59, 130, 246, 0.2);
        --accent-focus-shadow: rgba(59, 130, 246, 0.1);
        --accent-approve-gradient-start: #10b981;
        --accent-approve-gradient-end: #059669;
        --accent-approve-text: #10b981;
        --accent-approve-shadow: rgba(16, 185, 129, 0.3);
        --accent-reject-gradient-start: #ef4444;
        --accent-reject-gradient-end: #dc2626;
        --accent-reject-text: #ef4444;
        --accent-reject-shadow: rgba(239, 68, 68, 0.3);
        --accent-cancel-gradient-start: #64748b;
        --accent-cancel-gradient-end: #475569;
        --accent-cancel-text: #64748b;
        --scrollbar-track-bg: rgba(15, 23, 42, 0.5);
        --scrollbar-thumb-bg: #334155;
        --scrollbar-thumb-hover-bg: #475569;
        --success-bg: rgba(16, 185, 129, 0.1);
        --success-border: rgba(16, 185, 129, 0.3);
        --success-text: #10b981;
        --error-bg: rgba(239, 68, 68, 0.1);
        --error-border: rgba(239, 68, 68, 0.3);
        --error-text: #ef4444;
        --info-bg: rgba(59, 130, 246, 0.1);
        --info-border: rgba(59, 130, 246, 0.3);
        --info-text: #3b82f6;
        --pending-bg: rgba(245, 158, 11, 0.1);
        --pending-border: rgba(245, 158, 11, 0.3);
        --pending-text: #f59e0b;
        --cancelled-bg: rgba(100, 116, 139, 0.1);
        --cancelled-border: rgba(100, 116, 139, 0.3);
        --cancelled-text: #64748b;
    }

    /* --- GLOBAL STYLES USING VARIABLES --- */
    body {
        display: flex;
        min-height: 100vh;
        background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
        color: var(--text-primary);
        overflow-x: hidden;
    }

    /* Sidebar */
    .sidebar { width: 280px; background: var(--sidebar-bg); backdrop-filter: blur(10px); color: var(--text-secondary); display: flex; flex-direction: column; padding: 30px 20px; border-right: 1px solid var(--border-color); box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2); z-index: 100; flex-shrink: 0; }
    .logo-container { display: flex; align-items: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
    .logo-icon { background: linear-gradient(135deg, var(--accent-gradient-start) 0%, var(--accent-gradient-end) 100%); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
    .logo-icon i { color: white; font-size: 20px; }
    .logo-text { font-size: 1.5rem; font-weight: 700; background: linear-gradient(135deg, var(--accent-gradient-start) 0%, var(--accent-gradient-end) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .sidebar a { text-decoration: none; color: var(--text-secondary); margin-bottom: 15px; font-weight: 500; padding: 12px 15px; border-radius: 10px; display: flex; align-items: center; transition: all 0.3s ease; }
    .sidebar a i { margin-right: 12px; width: 20px; text-align: center; font-size: 1.1rem; }
    .sidebar a:hover, .sidebar a.active { background: var(--accent-hover-bg); color: var(--accent-text); transform: translateX(5px); }
    .sidebar a.logout { margin-top: auto; color: var(--accent-reject-text); border: 1px solid var(--accent-reject-shadow); }
    .sidebar a.logout:hover { background: var(--error-bg); transform: translateX(5px); }

    /* Main Content Area */
    .main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }

    /* Header */
    header { height: 80px; display: flex; justify-content: space-between; align-items: center; padding: 0 40px; background: var(--header-bg); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1); flex-shrink: 0; }
    header h1 { font-size: 1.8rem; font-weight: 600; color: var(--text-secondary); }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-gradient-start) 0%, var(--accent-gradient-end) 100%); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.2rem; box-shadow: 0 4px 10px var(--accent-focus-shadow); color: white; }
    .user-details { text-align: right; }
    .user-details .sender-id { font-weight: 600; color: var(--text-muted); }
    .user-details .sender-id span { color: var(--accent-text); }
    .user-details .email { font-size: 0.9rem; color: var(--text-muted); }

    /* Dashboard Content Area */
    .dashboard-content { padding: 30px 40px; flex-grow: 1; }

    /* Card Styles */
    .card { background: var(--card-bg); backdrop-filter: blur(10px); border-radius: 16px; padding: 25px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); border: 1px solid var(--border-color); animation: fadeInUp 0.6s ease-out; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .card-header { display: flex; align-items: center; margin-bottom: 20px; color: var(--text-secondary); font-size: 1.2rem; font-weight: 600; }
    .card-header i { margin-right: 10px; font-size: 1.4rem; color: var(--accent-text); }

    /* Button Styles */
    .btn { padding: 12px 24px; border: none; border-radius: 10px; color: white; cursor: pointer; transition: all 0.3s ease; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; }
    .btn:hover { transform: translateY(-2px); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { background: #475569; color: var(--text-disabled); cursor: not-allowed; transform: none; box-shadow: none; }
    .action-btn { background: linear-gradient(135deg, var(--accent-gradient-start), var(--accent-gradient-end)); box-shadow: 0 4px 15px var(--accent-focus-shadow); }
    .action-btn:hover { box-shadow: 0 8px 20px var(--accent-focus-shadow); }

    /* List Containers (Requests) */
    .list-container { margin-top: 15px; padding: 15px; border-radius: 12px; background: var(--input-bg); border: 1px solid var(--border-color); font-size: 14px; color: var(--text-secondary); min-height: 150px; /* Removed max-height */ overflow-y: auto; } /* Let it grow */
    .list-container::-webkit-scrollbar { width: 8px; }
    .list-container::-webkit-scrollbar-track { background: var(--scrollbar-track-bg); border-radius: 10px; }
    .list-container::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb-bg); border-radius: 10px; }
    .list-container::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover-bg); }

    /* Empty State */
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100px; color: var(--text-muted); text-align: center; padding: 20px; }
    .empty-state i { font-size: 2rem; margin-bottom: 10px; opacity: 0.5; }

    /* Status Messages (Embedded in #pageStatus div) */
    .status-message { padding: 12px; border-radius: 8px; text-align: center; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px; animation: fadeInUp 0.3s ease-out; border: 1px solid transparent;}
    .status-success { background: var(--success-bg); border-color: var(--success-border); color: var(--success-text); }
    .status-error { background: var(--error-bg); border-color: var(--error-border); color: var(--error-text); }
    .status-info { background: var(--info-bg); border-color: var(--info-border); color: var(--info-text); }
    #pageStatus { margin-bottom: 20px; } /* Space below status */

    /* Footer */
    footer { padding: 20px 40px; text-align: center; margin-top: auto; color: var(--text-muted); font-size: 0.9rem; border-top: 1px solid var(--border-color); flex-shrink: 0; }

    /* --- Styles Specific to Request Items --- */
    .request {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 15px; padding: 15px; border-radius: 12px;
        background: var(--list-item-bg); border: 1px solid var(--border-input);
        transition: background 0.3s, border-color 0.3s;
    }
    .request:hover { background: var(--list-item-hover-bg); border-color: var(--border-focus); }
    .request-info { display: flex; flex-direction: column; flex: 1; }
    .request-email { font-weight: 600; color: var(--accent-text); }
    .request-date { font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; }
    .request-actions { display: flex; gap: 10px; }
    .approve-btn { background: linear-gradient(135deg, var(--accent-approve-gradient-start), var(--accent-approve-gradient-end)); box-shadow: 0 4px 15px var(--accent-approve-shadow); padding: 10px 16px; font-size: 0.9rem; }
    .approve-btn:hover { box-shadow: 0 8px 20px var(--accent-approve-shadow); }
    .reject-btn { background: linear-gradient(135deg, var(--accent-reject-gradient-start), var(--accent-reject-gradient-end)); box-shadow: 0 4px 15px var(--accent-reject-shadow); padding: 10px 16px; font-size: 0.9rem; }
    .reject-btn:hover { box-shadow: 0 8px 20px var(--accent-reject-shadow); }
    /* --- End Specific Styles --- */

    /* Responsive */
    @media (max-width: 768px) {
        body { flex-direction: column; }
        .sidebar { width: 100%; height: auto; padding: 20px; flex-direction: row; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .logo-container { width: 100%; justify-content: center; margin-bottom: 20px; }
        .sidebar a { margin-bottom: 0; padding: 10px 15px; font-size: 0.9rem; }
        .sidebar a.logout { margin-top: 0; }
        header { padding: 0 20px; height: 70px; }
        header h1 { font-size: 1.5rem; }
        .dashboard-content { padding: 20px; }
        .request { flex-direction: column; gap: 15px; text-align: center; }
        .request-actions { width: 100%; justify-content: center; }
    }
    @media (max-width: 480px) {
        header { flex-direction: column; height: auto; padding: 15px; gap: 10px; }
        .user-info { flex-direction: column; text-align: center; gap: 8px; }
        .user-details { text-align: center; }
    }
</style>
</head>
<body>

<div class="sidebar">
    <div class="logo-container">
        <div class="logo-icon"><i class="fas fa-shield-alt"></i></div>
        <div class="logo-text">SecureShare</div>
    </div>
    <a href="sender_dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
    <a href="encrypt.html"><i class="fas fa-paper-plane"></i> Encryption</a>
    <a href="uploadfiles.html"><i class="fas fa-tasks"></i> Uploads & Accept</a>
    <a href="add_users.html"><i class="fas fa-user-plus"></i> Add Users</a>
    <a href="pending_requests.html"><i class="fas fa-clock"></i> Pending Requests</a>
    <a href="encrypt_instructions.html" class="active"><i class="fas fa-question-circle"></i> How to Encrypt/Send</a>
     <a href="#" class="logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
    </a>
</div>

<div class="main">
    <header>
        <h1>Pending File Requests</h1>
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-details">
                <div class="sender-id">ID: <span id="senderId">Loading...</span></div>
                <div class="email" id="emailDisplay">Loading...</div>
            </div>
        </div>
    </header>

    <div class="dashboard-content">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-inbox"></i>
                <h2>Manage Incoming Requests</h2>
            </div>

            <div id="pageStatus"></div>

            <button class="btn action-btn" id="refreshBtn" onclick="fetchPendingRequests()" style="margin-bottom: 20px;">
                <i class="fas fa-sync-alt"></i> Refresh Requests
            </button>

            <div id="requestsList" class="list-container" > <div class="empty-state">
                    <i class="fas fa-hourglass-half"></i>
                    <p>Click Refresh to check for requests</p>
                </div>
            </div>
        </div>
    </div>
    <footer>
        &copy; 2025 SecureShare. All rights reserved.
    </footer>
</div>

<script>
    // --- Removed AWS DDB Setup ---
    const API_URL = '';
    const senderId = localStorage.getItem('senderId');
    const email = localStorage.getItem('email'); // Sender's email
    const userName = email ? email.split('@')[0] : 'User';

    document.addEventListener('DOMContentLoaded', () => {
        if (!senderId || !email) {
            alert('No sender info found. Redirecting to login.');
            window.location.href = 'login.html';
            return;
        }
        // Populate header
        document.getElementById('senderId').textContent = senderId;
        document.getElementById('emailDisplay').textContent = email;
        document.getElementById('userAvatar').textContent = getUserInitials(userName);
        fetchPendingRequests(); // Fetch requests on load
    });

    function getUserInitials(name) {
         if (!name) return 'U';
         return name.split(/[\s@_.]+/).map(n => n[0]).join('').substring(0, 2).toUpperCase();
     }

    // --- Show Status Function ---
    function showStatusMessage(type, message) {
        const statusEl = document.getElementById("pageStatus");
        const iconClass = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle');
        statusEl.innerHTML = `
            <div class="status-message status-${type}">
                <i class="fas ${iconClass}"></i>
                <span>${message}</span>
            </div>`;
        if (type === 'success' || type === 'info') {
            setTimeout(() => {
                const currentMsgSpan = statusEl.querySelector(`.${type} span`);
                if (currentMsgSpan && currentMsgSpan.textContent === message) { statusEl.innerHTML = ''; }
            }, 4000);
        }
    }

    // --- Fetch Pending Requests from Backend ---
    async function fetchPendingRequests() {
        const requestsElement = document.getElementById("requestsList");
        const refreshBtn = document.getElementById('refreshBtn');
        requestsElement.innerHTML = `<div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading requests...</p></div>`;
        if(refreshBtn) { refreshBtn.disabled = true; refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...'; }
        showStatusMessage('info', 'Fetching pending requests...');

        try {
            const response = await fetch(`${API_URL}/sender-requests/${senderId}/pending`);
             if (!response.ok) {
                 const errData = await response.json().catch(() => ({ message: `HTTP Error ${response.status}` }));
                 throw new Error(errData.message || `HTTP Error ${response.status}`);
             }
            const data = await response.json();
            if (!data.success) { throw new Error(data.message || 'Backend reported failure'); }

            let html = "";
            let requestCount = 0;

            if (data.requests && data.requests.length > 0) {
                data.requests.forEach(req => {
                    requestCount++;
                    html += `
                      <div class="request" id="request-${escapeHtml(req.receiverEmail)}">
                        <div class="request-info">
                          <span class="request-email">${escapeHtml(req.receiverEmail)}</span>
                          <span class="request-date">Requested on: ${new Date(req.requestedAt || Date.now()).toLocaleDateString()}</span>
                        </div>
                        <div class="request-actions">
                          <button class="btn approve-btn" onclick="approveRequest('${escapeHtml(req.receiverEmail)}')">
                            <i class="fas fa-check"></i> Approve
                          </button>
                          <button class="btn reject-btn" onclick="rejectRequest('${escapeHtml(req.receiverEmail)}')">
                            <i class="fas fa-times"></i> Deny
                          </button>
                        </div>
                      </div>`;
                });
            }

            if (requestCount > 0) {
                requestsElement.innerHTML = html;
                 showStatusMessage('success', `Loaded ${requestCount} pending request(s).`);
            } else {
                requestsElement.innerHTML = `<div class="empty-state"><i class="fas fa-check-circle"></i><p>No pending requests found.</p></div>`;
                showStatusMessage('info', 'No pending requests found.');
            }
        } catch(err){
            console.error("Error loading requests:", err);
            requestsElement.innerHTML = `<div class="status-message error"><i class="fas fa-exclamation-triangle"></i> Failed to load requests: ${err.message}</div>`;
             showStatusMessage('error', 'Failed to load requests.');
        } finally {
             if(refreshBtn) { refreshBtn.disabled = false; refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Requests'; }
        }
    }

    // --- Approve Request (Calls Backend API) ---
    async function approveRequest(receiverEmail){
        showStatusMessage('info', `Approving request from ${receiverEmail}...`);
        disableRequestButtons(receiverEmail);

        try {
            const response = await fetch(`${API_URL}/mark-request-approved`, {
                 method: 'POST', headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify({ senderId: senderId, receiverEmail: receiverEmail })
            });
             if (!response.ok) {
                 const errData = await response.json().catch(() => ({ message: `HTTP Error ${response.status}` }));
                 throw new Error(errData.message || `HTTP Error ${response.status}`);
             }
             const data = await response.json();
             if (data.success) {
                showStatusMessage('success', `Request from ${receiverEmail} approved. Go to 'Uploads & Requests' page to upload the file.`);
                const requestElement = document.getElementById(`request-${escapeHtml(receiverEmail)}`);
                if (requestElement) {
                    requestElement.style.transition = 'opacity 0.3s ease-out';
                    requestElement.style.opacity = '0';
                    setTimeout(() => requestElement.remove(), 300);
                }
                setTimeout(checkIfListIsEmpty, 350);
             } else { throw new Error(data.message || 'Backend reported approval failure'); }
        } catch (error) {
            console.error("Approval error:", error);
            showStatusMessage('error', `Failed to approve request from ${receiverEmail}: ${error.message}`);
            enableRequestButtons(receiverEmail);
        }
    }

    // --- Reject Request (Calls Backend API) ---
    async function rejectRequest(receiverEmail){
        if (!confirm(`Are you sure you want to deny the request from ${receiverEmail}?`)) return;
        showStatusMessage('info', `Denying request from ${receiverEmail}...`);
        disableRequestButtons(receiverEmail);

        try {
             const response = await fetch(`${API_URL}/deny-request`, {
                 method: 'POST', headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify({ senderId: senderId, receiverEmail: receiverEmail })
             });
              if (!response.ok) {
                 const errData = await response.json().catch(() => ({ message: `HTTP Error ${response.status}` }));
                 throw new Error(errData.message || `HTTP Error ${response.status}`);
             }
             const data = await response.json();
             if (data.success) {
                 showStatusMessage('success', `Request from ${receiverEmail} denied successfully.`);
                 const requestElement = document.getElementById(`request-${escapeHtml(receiverEmail)}`);
                 if (requestElement) {
                     requestElement.style.transition = 'opacity 0.3s ease-out';
                     requestElement.style.opacity = '0';
                     setTimeout(() => requestElement.remove(), 300);
                 }
                 setTimeout(checkIfListIsEmpty, 350);
             } else { throw new Error(data.message || 'Backend reported denial failure'); }
        } catch (error) {
            console.error("Denial error:", error);
            showStatusMessage('error', `Failed to deny request from ${receiverEmail}: ${error.message}`);
            enableRequestButtons(receiverEmail);
        }
    }

    // --- Helper Functions for UI ---
    function disableRequestButtons(receiverEmail) {
        const requestElement = document.getElementById(`request-${escapeHtml(receiverEmail)}`);
         if (requestElement) {
            requestElement.querySelectorAll('.request-actions button').forEach(btn => {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            });
        }
    }

    function enableRequestButtons(receiverEmail) {
         const requestElement = document.getElementById(`request-${escapeHtml(receiverEmail)}`);
          if (requestElement) {
            const approveBtn = requestElement.querySelector('.approve-btn');
            const rejectBtn = requestElement.querySelector('.reject-btn');
            if (approveBtn) {
                 approveBtn.disabled = false;
                 approveBtn.innerHTML = '<i class="fas fa-check"></i> Approve';
            }
             if (rejectBtn) {
                 rejectBtn.disabled = false;
                 rejectBtn.innerHTML = '<i class="fas fa-times"></i> Deny';
            }
        }
    }

     function checkIfListIsEmpty() {
         const requestsElement = document.getElementById("requestsList");
         if (!requestsElement.querySelector('.request')) {
             requestsElement.innerHTML = `<div class="empty-state"><i class="fas fa-check-circle"></i><p>No more pending requests.</p></div>`;
         }
     }
    function escapeHtml(unsafe) {
         if (!unsafe) return '';
         return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
     }
    function logout(){
       localStorage.clear();
       window.location.href='login.html';
     }

</script>

</body>
</html>